<article
  class="envelope-card"
  id="env-{{ env.id }}"
  x-data="{ showDeposit: false, spending: false, depositing: false }"
>
  <header class="card-header" style="border-bottom: none; padding: 0; margin-bottom: 0.5rem;">
    <strong style="font-size: 1.1rem; letter-spacing: -0.01em;">{{ env.name }}</strong>
    <form action="{{ url_for('archive_envelope', envelope_id=env.id) }}" method="post" style="margin: 0;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="submit" class="btn-archive" aria-label="Archive">
        <small>Archive</small>
      </button>
    </form>
  </header>

  <div class="balance-display">
    {% set is_surplus = env.balance > env.base_amount %}
    {% set is_low_balance = env.base_amount and env.balance < (env.base_amount / 10) %}
    <h2
      id="balance-val-{{ env.id }}"
      class="{% if env.balance < 0 %}negative{% endif %}"
    >
      {{ env.balance|currency }}
    </h2>
    <progress
      id="progress-{{ env.id }}"
      class="{% if is_surplus %}surplus{% endif %}{% if is_low_balance %}{% if is_surplus %} {% endif %}low-balance{% endif %}"
      value="{{ env.balance if env.balance > 0 else 0 }}"
      max="{{ env.balance if is_surplus else env.base_amount }}"
      style="--pico-progress-color: var(--pico-primary);"
    ></progress>
  </div>

  {% if error %}
    <p
      class="error-message"
      role="alert"
      style="margin: 0.5rem 0 0; color: var(--pico-del-color); font-weight: 600;"
    >
      {{ error }}
    </p>
  {% endif %}

  <div class="actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
    <button
      type="button"
      class="outline"
      @click="showDeposit = false"
      :class="!showDeposit && 'primary'"
      :aria-pressed="showDeposit === false"
    >
      Spend
    </button>
    <button
      type="button"
      class="outline"
      @click="showDeposit = true"
      :class="showDeposit && 'primary'"
      :aria-pressed="showDeposit === true"
    >
      Deposit
    </button>
  </div>

  <form
    hx-post="{{ url_for('spend', envelope_id=env.id) }}"
    hx-target="#env-{{ env.id }}"
    hx-swap="outerHTML"
    hx-indicator="#spend-indicator-{{ env.id }}"
    action="{{ url_for('spend', envelope_id=env.id) }}"
    method="post"
    class="spend-form"
    x-show="showDeposit === false"
    x-transition:enter="transition-smooth"
    x-transition:enter-start="opacity-0 transform -translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-cloak
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <fieldset role="group">
      <input
        type="number"
        name="amount"
        step="0.01"
        min="0"
        placeholder="Amount spent..."
        required
      />
      <button
        type="submit"
        id="spend-button-{{ env.id }}"
        x-bind:disabled="spending"
        @click="spending = true"
      >
        Spend
      </button>
    </fieldset>
    <input
      type="text"
      name="note"
      placeholder="Note (optional)..."
      maxlength="255"
    />
    <small
      id="spend-indicator-{{ env.id }}"
      class="htmx-indicator loading-indicator"
      role="status"
      aria-live="polite"
    >
      Processing...
    </small>
  </form>

  <form
    hx-post="{{ url_for('add_funds', envelope_id=env.id) }}"
    hx-target="#env-{{ env.id }}"
    hx-swap="outerHTML"
    action="{{ url_for('add_funds', envelope_id=env.id) }}"
    method="post"
    class="deposit-form"
    x-show="showDeposit === true"
    x-transition:enter="transition-smooth"
    x-transition:enter-start="opacity-0 transform -translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-cloak
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <fieldset role="group">
      <input
        type="number"
        name="amount"
        step="0.01"
        min="0"
        placeholder="Amount deposited..."
        required
      />
      <button
        type="submit"
        id="deposit-button-{{ env.id }}"
        x-bind:disabled="depositing"
        @click="depositing = true"
      >Deposit</button>
    </fieldset>
  </form>
</article>
