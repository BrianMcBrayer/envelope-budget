<article class="envelope-card" id="env-{{ env.id }}" x-data="{ mode: 'view' }">
  <div class="card-header">
    <h3>{{ env.name }}</h3>
    <form action="{{ url_for('archive_envelope', envelope_id=env.id) }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="submit" class="outline secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
        Archive
      </button>
    </form>
  </div>

  <div class="balance-section">
    <div class="balance-large {% if env.balance < 0 %}text-danger{% endif %}">
      {{ env.balance|currency }}
    </div>

    <progress
      value="{{ env.balance if env.balance > 0 else 0 }}"
      max="{{ env.base_amount }}"
      style="margin-bottom: 1rem;"
    ></progress>

    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b;">
      <span>Target: {{ env.base_amount|currency }}</span>
      <span style="text-transform: capitalize;">{{ env.mode }}</span>
    </div>
  </div>

  {% if error %}
    <div style="background: #fee2e2; color: #991b1b; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
      <small>{{ error }}</small>
    </div>
  {% endif %}

  <hr style="margin: 1rem 0;">

  <div class="grid" x-show="mode === 'view'">
    <button @click="mode = 'spend'" class="outline contrast">Spend</button>
    <button @click="mode = 'deposit'" class="outline">Add Funds</button>
  </div>

  <form
    x-show="mode === 'spend'"
    hx-post="{{ url_for('spend', envelope_id=env.id) }}"
    hx-target="#env-{{ env.id }}"
    hx-swap="outerHTML"
    style="margin-bottom: 0;"
    x-cloak
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <label>
        <small>Amount to spend</small>
        <input type="number" name="amount" step="0.01" min="0" required autofocus />
    </label>
    <input type="text" name="note" placeholder="Note (optional)" />
    <div class="grid">
        <button type="submit" class="contrast">Confirm</button>
        <button type="button" class="outline secondary" @click="mode = 'view'">Cancel</button>
    </div>
  </form>

  <form
    x-show="mode === 'deposit'"
    hx-post="{{ url_for('add_funds', envelope_id=env.id) }}"
    hx-target="#env-{{ env.id }}"
    hx-swap="outerHTML"
    style="margin-bottom: 0;"
    x-cloak
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <label>
        <small>Amount to deposit</small>
        <input type="number" name="amount" step="0.01" min="0" required autofocus />
    </label>
    <div class="grid">
        <button type="submit">Confirm</button>
        <button type="button" class="outline secondary" @click="mode = 'view'">Cancel</button>
    </div>
  </form>
</article>
